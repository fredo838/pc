# --- CORE SELECTION ENGINE ---

# Selection Wrapper
widget::util-select() {
  local target_widget=$1
  if (( ! REGION_ACTIVE )); then
    zle set-mark-command
  fi
  zle $target_widget
}

# Explicit Unselect Wrapper
widget::util-unselect() {
  REGION_ACTIVE=0
  zle $1
}

# Create widgets
foreach w (backward-char forward-char backward-word forward-word beginning-of-line end-of-line) {
  eval "${w}-select() { widget::util-select $w }"
  eval "${w}-unselect() { widget::util-unselect $w }"
  zle -N "${w}-select"
  zle -N "${w}-unselect"
}

# --- CLIPBOARD FUNCTIONS ---

copy-to-mac() {
    if (( REGION_ACTIVE )); then
        # Determine selection boundaries
        # Zsh $CURSOR is 0-indexed; $BUFFER slicing is 1-indexed
        local low=$(( MARK < CURSOR ? MARK : CURSOR ))
        local high=$(( MARK > CURSOR ? MARK : CURSOR ))
        local selection=$BUFFER[$((low + 1)),$high]

        # Debug Log


        # Sync to Mac
        print -rn -- "$selection" | pbcopy
        
        # Set the Zsh kill ring so native 'yank' works
        CUTBUFFER="$selection"

        # MOVE CURSOR TO END
        CURSOR=$high
        
        # Reset selection
        REGION_ACTIVE=0
    fi
}
zle -N copy-to-mac

paste-from-mac() {
    local pasted="$(pbpaste)"
    

    # If overwriting a selection
    if (( REGION_ACTIVE )); then
        local low=$(( MARK < CURSOR ? MARK : CURSOR ))
        local high=$(( MARK > CURSOR ? MARK : CURSOR ))
        BUFFER=$BUFFER[1,$low]$pasted$BUFFER[$((high + 1)),-1]
        CURSOR=$(( low + ${#pasted} ))
    else
        # Standard insert
        LBUFFER+="$pasted"
    fi
    
    REGION_ACTIVE=0
}
zle -N paste-from-mac

# --- BINDINGS ---

# 1. SHIFT + ARROWS
bindkey "\e[1;2C" forward-char-select
bindkey "\e[1;2D" backward-char-select

# 2. CTRL + SHIFT + ARROWS
bindkey "\e[1;6C" forward-word-select
bindkey "\e[1;6D" backward-word-select

# 3. HOME / END
bindkey "\e[H"    beginning-of-line-unselect
bindkey "\e[F"    end-of-line-unselect
bindkey "\e[1;2H" beginning-of-line-select
bindkey "\e[1;2F" end-of-line-select
bindkey "\e[1;6H" beginning-of-line-select
bindkey "\e[1;6F" end-of-line-select

# 4. PLAIN MOVEMENTS
bindkey "\e[C"  forward-char-unselect
bindkey "\e[D"  backward-char-unselect
bindkey "\eOC"  forward-char-unselect
bindkey "\eOD"  backward-char-unselect
bindkey "\e[1;5C" forward-word-unselect
bindkey "\e[1;5D" backward-word-unselect

# 5. CLIPBOARD (Check these sequences in your terminal settings!)
bindkey "\e[1;6X" copy-to-mac
bindkey "\e[1;6Y" paste-from-mac

# --- CURSOR ---
echo -ne '\e[5 q'